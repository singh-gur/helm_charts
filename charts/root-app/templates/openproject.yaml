{{- if .Values.openproject.enabled }}
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: openproject
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://charts.openproject.org
    chart: openproject
    targetRevision: {{.Values.openproject.version}}
    helm:
      values: |
        ingress:
          enabled: true
          hosts:
            - host: {{.Values.openproject.ingress.host}}
              paths:
                - path: /
                  pathType: Prefix
        postgresql:
          bundled: {{.Values.openproject.postgresql.bundled}}
          connection:
            host: {{.Values.openproject.postgresql.host}}
            port: {{.Values.openproject.postgresql.port | default 5432}}
          auth:
            existingSecret: openproject-db-secrets
            username: {{.Values.openproject.postgresql.username}}
            database: {{.Values.openproject.postgresql.database}}
        openproject:
          oidc:
            enabled: {{.Values.openproject.oidc.enabled}}
            {{- if .Values.openproject.oidc.enabled }}
            provider: {{.Values.openproject.oidc.provider}}
            displayName: {{.Values.openproject.oidc.displayName}}
            host: {{.Values.openproject.oidc.host}}
            scope: {{.Values.openproject.oidc.scope}}
            authorizationEndpoint: {{.Values.openproject.oidc.authorizationEndpoint}}
            tokenEndpoint: {{.Values.openproject.oidc.tokenEndpoint}}
            userinfoEndpoint: {{.Values.openproject.oidc.userinfoEndpoint}}
            endSessionEndpoint: {{.Values.openproject.oidc.endSessionEndpoint}}
            existingSecret: openproject-secrets
            secretKeys:
              identifier: oidc-client-id
              secret: oidc-client-secret
            {{- end }}
  destination:
    server: https://kubernetes.default.svc
    namespace: default
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
{{- end }}