{{- if .Values.trino.enabled }}
{{- $trino := .Values.trino }}
{{- $iceberg := $trino.catalogs.iceberg | default dict }}
{{- $icebergS3 := $iceberg.s3 | default dict }}
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  namespace: {{ .Values.argocdNamespace | default "default" }}
  name: trino
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://trinodb.github.io/charts/
    chart: trino
    targetRevision: {{ $trino.version }}
    helm:
      values: |
        server:
          workers: {{ default 4 $trino.server.workers }}
          {{- if and $trino.auth $trino.auth.enabled }}
          config:
            authenticationType: "PASSWORD"
          {{- end }}
        {{- if and $trino.auth $trino.auth.enabled }}
        additionalConfigProperties:
          - http-server.process-forwarded=true
          - internal-communication.shared-secret=${ENV:TRINO_SHARED_SECRET}
        {{- end }}
        {{- if and $trino.auth $trino.auth.enabled }}
        auth:
          passwordAuthSecret: {{ $trino.auth.passwordAuthSecret | quote }}
          {{- if and $trino.auth.groups $trino.auth.groups.enabled }}
          groupsAuthSecret: {{ $trino.auth.groups.groupsAuthSecret | quote }}
          {{- end }}
        {{- end }}
        catalogs:
          {{- if and $iceberg $iceberg.enabled }}
          {{ default "iceberg" $iceberg.catalogName }}: |
            connector.name=iceberg
            iceberg.catalog.type=jdbc
            iceberg.jdbc-catalog.connection-url=jdbc:postgresql://${ENV:POSTGRES_HOST}:${ENV:POSTGRES_PORT}/${ENV:POSTGRES_DATABASE}
            iceberg.jdbc-catalog.default-warehouse-dir={{ $iceberg.warehouse }}
            iceberg.jdbc-catalog.driver-class=org.postgresql.Driver
            iceberg.jdbc-catalog.catalog-name={{ default "iceberg" $iceberg.catalogName }}
            iceberg.jdbc-catalog.connection-user=${ENV:POSTGRES_USER}
            iceberg.jdbc-catalog.connection-password=${ENV:POSTGRES_PASSWORD}
            fs.native-s3.enabled=true
            {{- if $icebergS3.endpoint }}
            s3.endpoint={{ $icebergS3.endpoint }}
            {{- end }}
            {{- if $icebergS3.region }}
            s3.region={{ $icebergS3.region }}
            {{- end }}
            {{- if hasKey $icebergS3 "pathStyleAccess" }}
            s3.path-style-access={{ ternary "true" "false" (default false $icebergS3.pathStyleAccess) }}
            {{- end }}
          {{- end }}
        ingress:
          enabled: true
          hosts:
          - host: {{ $trino.ingress.host }}
            paths:
            - path: /
              pathType: Prefix
          tls: []
          {{- end }}
        {{- if or (and $iceberg $iceberg.enabled $iceberg.credentialsSecret) (and $trino.auth $trino.auth.enabled $trino.auth.sharedSecretName) }}
        envFrom:
        {{- if and $iceberg $iceberg.enabled $iceberg.credentialsSecret }}
        - secretRef:
            name: {{ $iceberg.credentialsSecret }}
        {{- end }}
        {{- if and $trino.auth $trino.auth.enabled $trino.auth.sharedSecretName }}
        - secretRef:
            name: {{ $trino.auth.sharedSecretName }}
        {{- end }}
        {{- end }}
  destination:
    server: https://kubernetes.default.svc
    namespace: {{ $trino.namespace | default "default" }}
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
{{- end }}
